{% extends "base.html" %}

{% block title %}Mapa Interactivo - Portal Barrio Privado{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="bi bi-geo-alt me-2"></i>Mapa Interactivo del Barrio
            </h2>
            <p class="text-muted mb-0">Explora las instalaciones y ubicaciones de forma interactiva</p>
        </div>
        <div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="showAll()">
                    <i class="bi bi-eye me-2"></i>Ver Todo
                </button>
                <button type="button" class="btn btn-outline-info" onclick="resetView()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Reiniciar
                </button>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Filtros</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="residences" id="filterResidences" checked>
                                <label class="form-check-label" for="filterResidences">
                                    <span class="badge bg-primary me-2">■</span>Residencias
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="common" id="filterCommon" checked>
                                <label class="form-check-label" for="filterCommon">
                                    <span class="badge bg-success me-2">■</span>Áreas Comunes
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="services" id="filterServices" checked>
                                <label class="form-check-label" for="filterServices">
                                    <span class="badge bg-warning me-2">■</span>Servicios
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="recreation" id="filterRecreation" checked>
                                <label class="form-check-label" for="filterRecreation">
                                    <span class="badge bg-info me-2">■</span>Recreación
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Buscar Ubicación</h6>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchLocation" placeholder="Buscar manzana, casa...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchLocation()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Map Container -->
    <div class="card">
        <div class="card-body p-0">
            <div id="mapContainer" style="position: relative; height: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <!-- Interactive Map will be here -->
                <div id="interactiveMap" style="width: 100%; height: 100%; position: relative; overflow: hidden; border-radius: 8px;">
                    <!-- Blocks and facilities will be positioned absolutely -->
                </div>
                
                <!-- Zoom Controls -->
                <div class="zoom-controls">
                    <button class="btn btn-light btn-sm" onclick="zoomIn()" title="Acercar">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button class="btn btn-light btn-sm" onclick="zoomOut()" title="Alejar">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Information Panel -->
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Información de Ubicación</h6>
                    <div id="locationInfo">
                        <p class="text-muted">Haz clic en cualquier elemento del mapa para ver información detallada.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Estadísticas del Barrio</h6>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary">55</h4>
                                <small class="text-muted">Total Casas</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">46</h4>
                            <small class="text-muted">Ocupadas</small>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">Ocupación:</small>
                        <small class="text-success fw-bold">84%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Info Modal -->
<div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="infoModalTitle">Información</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="infoModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
.map-block {
    position: absolute;
    border: 2px solid;
    border-radius: 10px;
    background: rgba(255,255,255,0.9);
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.map-block:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    z-index: 10;
}

.map-facility {
    position: absolute;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.map-facility:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 10;
}

.house-dot {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
}

.house-dot:hover {
    transform: scale(1.5);
    z-index: 10;
}

.house-dot.occupied {
    background: #28a745;
}

.house-dot.vacant {
    background: #ffc107;
}

.house-dot.premium {
    border: 2px solid #FFD700;
    width: 12px;
    height: 12px;
}

.zoom-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.highlighted {
    animation: pulse 1.5s infinite;
    filter: brightness(1.3) !important;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
</style>

<script>
let currentZoom = 1;

// Initialize map on page load
document.addEventListener('DOMContentLoaded', function() {
    createInteractiveMap();
    setupEventListeners();
});

function createInteractiveMap() {
    const mapContainer = document.getElementById('interactiveMap');
    
    // Create blocks
    createBlock('A', 50, 50, 160, 180, '#E3F2FD', '#1976D2', 'Manzana A<br>10/12 ocupadas');
    createBlock('B', 250, 50, 160, 180, '#E8F5E8', '#388E3C', 'Manzana B<br>12/15 ocupadas');
    createBlock('C', 50, 300, 160, 180, '#FFF3E0', '#F57C00', 'Manzana C<br>16/18 ocupadas');
    createBlock('D', 250, 300, 160, 180, '#F3E5F5', '#7B1FA2', 'Manzana D Premium<br>8/10 ocupadas');
    
    // Create facilities
    createFacility('clubhouse', 450, 80, 120, 60, '#4CAF50', 'Club House');
    createFacility('pool', 450, 200, 100, 80, '#03A9F4', 'Piscina');
    createFacility('tennis', 600, 100, 80, 60, '#FF9800', 'Tenis');
    createFacility('soccer', 600, 200, 80, 80, '#4CAF50', 'Fútbol');
    createFacility('playground', 450, 350, 80, 60, '#FF5722', 'Juegos');
    createFacility('security', 20, 250, 60, 40, '#F44336', 'Seguridad');
    createFacility('admin', 600, 350, 80, 60, '#9C27B0', 'Admin');
    
    // Add houses to blocks
    addHousesToBlock('A', 12, 10);
    addHousesToBlock('B', 15, 12);
    addHousesToBlock('C', 18, 16);
    addHousesToBlock('D', 10, 8, true); // Premium block
}

function createBlock(id, x, y, width, height, bgColor, borderColor, label) {
    const mapContainer = document.getElementById('interactiveMap');
    const block = document.createElement('div');
    block.className = 'map-block';
    block.setAttribute('data-block', id);
    block.setAttribute('data-category', 'residences');
    block.style.left = x + 'px';
    block.style.top = y + 'px';
    block.style.width = width + 'px';
    block.style.height = height + 'px';
    block.style.backgroundColor = bgColor;
    block.style.borderColor = borderColor;
    block.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-size: 14px; font-weight: bold; color: #333;">${label}</div>`;
    
    block.addEventListener('click', () => showBlockInfo(id));
    mapContainer.appendChild(block);
}

function createFacility(id, x, y, width, height, bgColor, label) {
    const mapContainer = document.getElementById('interactiveMap');
    const facility = document.createElement('div');
    facility.className = 'map-facility';
    facility.setAttribute('data-facility', id);
    facility.setAttribute('data-category', getFacilityCategory(id));
    facility.style.left = x + 'px';
    facility.style.top = y + 'px';
    facility.style.width = width + 'px';
    facility.style.height = height + 'px';
    facility.style.backgroundColor = bgColor;
    facility.style.fontSize = '12px';
    facility.innerHTML = label;
    
    facility.addEventListener('click', () => showFacilityInfo(id));
    mapContainer.appendChild(facility);
}

function getFacilityCategory(id) {
    if (['clubhouse'].includes(id)) return 'common';
    if (['pool', 'tennis', 'soccer', 'playground'].includes(id)) return 'recreation';
    return 'services';
}

function addHousesToBlock(blockId, total, occupied, isPremium = false) {
    const blockElement = document.querySelector(`[data-block="${blockId}"]`);
    const rect = blockElement.getBoundingClientRect();
    const containerRect = document.getElementById('interactiveMap').getBoundingClientRect();
    
    // Calculate relative positions
    const blockX = parseInt(blockElement.style.left);
    const blockY = parseInt(blockElement.style.top);
    const blockWidth = parseInt(blockElement.style.width);
    const blockHeight = parseInt(blockElement.style.height);
    
    // Create houses in a grid pattern
    const cols = Math.ceil(Math.sqrt(total));
    const rows = Math.ceil(total / cols);
    const marginX = 20;
    const marginY = 30;
    const availableWidth = blockWidth - (2 * marginX);
    const availableHeight = blockHeight - (2 * marginY) - 40; // Space for label
    const stepX = availableWidth / (cols - 1);
    const stepY = availableHeight / (rows - 1);
    
    for (let i = 0; i < total; i++) {
        const row = Math.floor(i / cols);
        const col = i % cols;
        const x = blockX + marginX + (col * stepX);
        const y = blockY + marginY + (row * stepY);
        
        createHouse(`${blockId}${i + 1}`, x, y, i < occupied, isPremium);
    }
}

function createHouse(id, x, y, isOccupied, isPremium = false) {
    const mapContainer = document.getElementById('interactiveMap');
    const house = document.createElement('div');
    house.className = `house-dot ${isOccupied ? 'occupied' : 'vacant'} ${isPremium ? 'premium' : ''}`;
    house.setAttribute('data-house', id);
    house.style.left = x + 'px';
    house.style.top = y + 'px';
    house.title = `Casa ${id} - ${isOccupied ? 'Ocupada' : 'Disponible'}`;
    
    house.addEventListener('click', (e) => {
        e.stopPropagation();
        showHouseInfo(id);
    });
    
    mapContainer.appendChild(house);
}

function setupEventListeners() {
    // Filter checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', applyFilters);
    });
    
    // Search input
    document.getElementById('searchLocation').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchLocation();
        }
    });
}

function applyFilters() {
    const residences = document.getElementById('filterResidences').checked;
    const common = document.getElementById('filterCommon').checked;
    const services = document.getElementById('filterServices').checked;
    const recreation = document.getElementById('filterRecreation').checked;
    
    // Show/hide elements based on filters
    document.querySelectorAll('[data-category="residences"]').forEach(el => {
        el.style.display = residences ? 'block' : 'none';
    });
    
    document.querySelectorAll('[data-category="common"]').forEach(el => {
        el.style.display = common ? 'block' : 'none';
    });
    
    document.querySelectorAll('[data-category="services"]').forEach(el => {
        el.style.display = services ? 'block' : 'none';
    });
    
    document.querySelectorAll('[data-category="recreation"]').forEach(el => {
        el.style.display = recreation ? 'block' : 'none';
    });
}

function showBlockInfo(blockId) {
    const blocks = {
        'A': { name: 'Manzana A', houses: 12, occupied: 10, description: 'Zona residencial principal con fácil acceso.' },
        'B': { name: 'Manzana B', houses: 15, occupied: 12, description: 'Área familiar cerca de la piscina.' },
        'C': { name: 'Manzana C', houses: 18, occupied: 16, description: 'La manzana más grande con acceso a deportes.' },
        'D': { name: 'Manzana D', houses: 10, occupied: 8, description: 'Zona premium con casas de lujo.' }
    };
    
    const data = blocks[blockId];
    const occupancyRate = Math.round((data.occupied / data.houses) * 100);
    
    document.getElementById('infoModalTitle').textContent = data.name;
    document.getElementById('infoModalBody').innerHTML = `
        <p><strong>Total de casas:</strong> ${data.houses}</p>
        <p><strong>Ocupadas:</strong> ${data.occupied}</p>
        <p><strong>Disponibles:</strong> ${data.houses - data.occupied}</p>
        <p><strong>Ocupación:</strong> ${occupancyRate}%</p>
        <div class="progress mb-3">
            <div class="progress-bar bg-success" style="width: ${occupancyRate}%"></div>
        </div>
        <p>${data.description}</p>
    `;
    
    new bootstrap.Modal(document.getElementById('infoModal')).show();
    highlightElement(`[data-block="${blockId}"]`);
}

function showFacilityInfo(facilityId) {
    const facilities = {
        'clubhouse': { name: 'Club House', type: 'Social', description: 'Centro social con salón de eventos y cocina.' },
        'pool': { name: 'Piscina', type: 'Recreación', description: 'Piscina climatizada con solarium.' },
        'tennis': { name: 'Cancha de Tenis', type: 'Deporte', description: 'Cancha profesional de tenis.' },
        'soccer': { name: 'Cancha de Fútbol', type: 'Deporte', description: 'Cancha de fútbol 7 con césped sintético.' },
        'playground': { name: 'Área de Juegos', type: 'Familiar', description: 'Zona de juegos para niños.' },
        'security': { name: 'Seguridad', type: 'Servicio', description: 'Puesto de control 24/7.' },
        'admin': { name: 'Administración', type: 'Servicio', description: 'Oficinas administrativas.' }
    };
    
    const data = facilities[facilityId];
    
    document.getElementById('infoModalTitle').textContent = data.name;
    document.getElementById('infoModalBody').innerHTML = `
        <p><strong>Tipo:</strong> ${data.type}</p>
        <p><strong>Descripción:</strong> ${data.description}</p>
        <p><strong>Estado:</strong> <span class="badge bg-success">Disponible</span></p>
    `;
    
    new bootstrap.Modal(document.getElementById('infoModal')).show();
    highlightElement(`[data-facility="${facilityId}"]`);
}

function showHouseInfo(houseId) {
    const isOccupied = document.querySelector(`[data-house="${houseId}"]`).classList.contains('occupied');
    const isPremium = document.querySelector(`[data-house="${houseId}"]`).classList.contains('premium');
    
    document.getElementById('infoModalTitle').textContent = `Casa ${houseId}`;
    document.getElementById('infoModalBody').innerHTML = `
        <p><strong>Estado:</strong> <span class="badge bg-${isOccupied ? 'success' : 'warning'}">${isOccupied ? 'Ocupada' : 'Disponible'}</span></p>
        <p><strong>Tipo:</strong> ${isPremium ? 'Premium' : 'Estándar'}</p>
        <p><strong>Superficie:</strong> ${isPremium ? '180m²' : '120m²'}</p>
        <p><strong>Habitaciones:</strong> ${isPremium ? '4' : '3'} dormitorios</p>
        ${!isOccupied ? '<div class="alert alert-info">Casa disponible para nueva familia.</div>' : ''}
    `;
    
    new bootstrap.Modal(document.getElementById('infoModal')).show();
    highlightElement(`[data-house="${houseId}"]`);
}

function searchLocation() {
    const searchTerm = document.getElementById('searchLocation').value.toLowerCase();
    
    if (searchTerm.includes('manzana') || ['a', 'b', 'c', 'd'].includes(searchTerm)) {
        const block = searchTerm.replace('manzana ', '').toUpperCase();
        if (['A', 'B', 'C', 'D'].includes(block)) {
            showBlockInfo(block);
            return;
        }
    }
    
    if (searchTerm.includes('piscina')) {
        showFacilityInfo('pool');
        return;
    }
    
    if (searchTerm.includes('tenis')) {
        showFacilityInfo('tennis');
        return;
    }
    
    if (searchTerm.includes('futbol') || searchTerm.includes('fútbol')) {
        showFacilityInfo('soccer');
        return;
    }
    
    alert('Ubicación no encontrada. Intenta con "Manzana A", "Piscina", etc.');
}

function highlightElement(selector) {
    document.querySelectorAll('.highlighted').forEach(el => {
        el.classList.remove('highlighted');
    });
    
    const element = document.querySelector(selector);
    if (element) {
        element.classList.add('highlighted');
        setTimeout(() => element.classList.remove('highlighted'), 3000);
    }
}

function showAll() {
    document.getElementById('filterResidences').checked = true;
    document.getElementById('filterCommon').checked = true;
    document.getElementById('filterServices').checked = true;
    document.getElementById('filterRecreation').checked = true;
    applyFilters();
    resetView();
}

function resetView() {
    currentZoom = 1;
    document.getElementById('interactiveMap').style.transform = 'scale(1)';
}

function zoomIn() {
    if (currentZoom < 2) {
        currentZoom += 0.2;
        document.getElementById('interactiveMap').style.transform = `scale(${currentZoom})`;
    }
}

function zoomOut() {
    if (currentZoom > 0.5) {
        currentZoom -= 0.2;
        document.getElementById('interactiveMap').style.transform = `scale(${currentZoom})`;
    }
}
</script>
{% endblock %}
