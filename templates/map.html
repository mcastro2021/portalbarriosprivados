{% extends "base.html" %}

{% block title %}Mapa del Barrio - Tejas Cuatro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-map me-2"></i>Mapa Interactivo - Tejas Cuatro
            </h2>
            <p class="text-muted mb-0">Explora las diferentes etapas y lotes del barrio</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="resetZoom()">
                <i class="bi bi-arrows-fullscreen me-2"></i>Vista Completa
            </button>
            <button class="btn btn-outline-info" onclick="toggleLegend()">
                <i class="bi bi-info-circle me-2"></i>Leyenda
            </button>
        </div>
    </div>

    <!-- Controles del Mapa -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-geo-alt me-2"></i>Mapa del Barrio
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomIn()">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomOut()">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Mensaje informativo -->
                    <div class="alert alert-info m-3 mb-0" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>¡Mapa Interactivo!</strong> Haz clic en las áreas de colores para ver información detallada. 
                        Usa los controles de zoom para navegar por el mapa.
                    </div>
                    
                    <div id="mapContainer" class="position-relative" style="height: 600px; overflow: hidden;">
                        <canvas id="mapCanvas" width="1200" height="800" style="cursor: crosshair;"></canvas>
                        
                        <!-- Overlay para información -->
                        <div id="mapInfo" class="position-absolute top-0 start-0 p-3" style="display: none;">
                            <div class="card bg-white shadow-sm">
                                <div class="card-body p-3">
                                    <h6 id="infoTitle" class="mb-2"></h6>
                                    <p id="infoDescription" class="mb-2 small"></p>
                                    <div id="infoDetails" class="small text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Información -->
        <div class="col-md-4">
            <!-- Leyenda -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-legend me-2"></i>Leyenda
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #FF0000;"></div>
                        <small>Etapa 1 - Vendida (Rojo)</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #00FF00;"></div>
                        <small>Etapa 2A - En Venta (Verde)</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #0000FF;"></div>
                        <small>Etapa 2B - Desarrollo (Azul)</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #FFFF00;"></div>
                        <small>Etapa 3 - Futuro (Amarillo)</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #00FF00;"></div>
                        <small>Espacios Verdes (Verde)</small>
                    </div>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>Estadísticas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <div class="h5 text-primary mb-0" id="totalLots">0</div>
                            <small class="text-muted">Total Lotes</small>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="h5 text-success mb-0" id="soldLots">0</div>
                            <small class="text-muted">Vendidos</small>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="h5 text-warning mb-0" id="availableLots">0</div>
                            <small class="text-muted">Disponibles</small>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="h5 text-info mb-0" id="greenAreas">0</div>
                            <small class="text-muted">Espacios Verdes</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del Lote Seleccionado -->
            <div class="card border-0 shadow-sm" id="lotInfoCard" style="display: none;">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-house me-2"></i>Información del Lote
                    </h6>
                </div>
                <div class="card-body">
                    <h6 id="lotTitle" class="mb-2"></h6>
                    <div class="mb-2">
                        <strong>Etapa:</strong> <span id="lotStage"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Área:</strong> <span id="lotArea"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Estado:</strong> <span id="lotStatus"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Descripción:</strong> <span id="lotDescription"></span>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary" onclick="showLotDetails()">
                            <i class="bi bi-info-circle me-1"></i>Ver Detalles
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="contactAboutLot()">
                            <i class="bi bi-envelope me-1"></i>Consultar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles del lote -->
<div class="modal fade" id="lotDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lotModalTitle">Detalles del Lote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="lotModalBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="contactAboutLot()">Consultar Disponibilidad</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let mapData = {{ blocks|map('to_dict')|list|tojson }};
let currentZoom = 1;
let isDragging = false;
let lastMousePos = { x: 0, y: 0 };
let selectedLot = null;

// Configuración del mapa
const mapConfig = {
    imageSrc: '{{ url_for("static", filename="images/tejas4-map.png") }}',
    width: 1200,
    height: 800,
    zoomLevels: {
        min: 0.5,
        max: 3,
        step: 0.2
    }
};

// Coordenadas de las etapas (basadas en la imagen)
const stageCoordinates = {
    'ETAPA_1': { x: 600, y: 400, width: 300, height: 200, color: '#FF0000' }, // Rojo brillante
    'ETAPA_2A': { x: 400, y: 200, width: 250, height: 150, color: '#00FF00' }, // Verde brillante
    'ETAPA_2B': { x: 200, y: 350, width: 200, height: 180, color: '#0000FF' }, // Azul brillante
    'ETAPA_3': { x: 500, y: 600, width: 280, height: 150, color: '#FFFF00' }  // Amarillo brillante
};

// Espacios verdes
const greenAreas = [
    { id: 'EV1', x: 800, y: 100, width: 100, height: 80, area: '8121.0m²', name: 'Espacio Verde 1' },
    { id: 'EV2', x: 750, y: 300, width: 80, height: 60, area: '2333.7m²', name: 'Espacio Verde 2' },
    { id: 'EV3', x: 500, y: 150, width: 90, height: 70, area: '2093.91m²', name: 'Espacio Verde 3' },
    { id: 'EV4', x: 150, y: 250, width: 40, height: 30, area: '314.16m²', name: 'Espacio Verde 4' },
    { id: 'EV5', x: 400, y: 500, width: 35, height: 25, area: '295.73m²', name: 'Espacio Verde 5' },
    { id: 'EV6', x: 100, y: 550, width: 120, height: 90, area: '5342.93m²', name: 'Espacio Verde 6' },
    { id: 'EV7', x: 450, y: 650, width: 30, height: 25, area: '350.40m²', name: 'Espacio Verde 7' }
];

// Inicializar mapa
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    updateStatistics();
});

function initializeMap() {
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    
    // Cargar imagen del mapa
    const mapImage = new Image();
    mapImage.onload = function() {
        drawMap();
    };
    mapImage.src = mapConfig.imageSrc;
    
    // Event listeners
    canvas.addEventListener('mousedown', startDrag);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', stopDrag);
    canvas.addEventListener('wheel', handleZoom);
    canvas.addEventListener('click', handleClick);
}

function drawMap() {
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    
    // Limpiar canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Dibujar fondo de prueba para verificar que el canvas funciona
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Dibujar borde del canvas
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, canvas.width, canvas.height);
    
    // Aplicar transformaciones
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(currentZoom, currentZoom);
    ctx.translate(-canvas.width/2, -canvas.height/2);
    
    // Dibujar imagen base (si existe)
    const mapImage = new Image();
    mapImage.onload = function() {
        ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
        
        // Dibujar áreas interactivas
        drawInteractiveAreas(ctx);
        
        // Dibujar tooltips si hay hover
        if (selectedLot) {
            drawTooltip(ctx, selectedLot);
        }
    };
    mapImage.onerror = function() {
        // Si la imagen no carga, dibujar un mensaje
        ctx.fillStyle = '#666';
        ctx.font = '24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Mapa de Tejas Cuatro', canvas.width/2, canvas.height/2 - 50);
        ctx.font = '16px Arial';
        ctx.fillText('(Imagen del mapa no disponible)', canvas.width/2, canvas.height/2);
        ctx.fillText('Haz clic en las áreas de colores para interactuar', canvas.width/2, canvas.height/2 + 30);
        
        // Dibujar áreas interactivas
        drawInteractiveAreas(ctx);
        
        // Dibujar tooltips si hay hover
        if (selectedLot) {
            drawTooltip(ctx, selectedLot);
        }
    };
    mapImage.src = mapConfig.imageSrc;
    
    ctx.restore();
}

function drawInteractiveAreas(ctx) {
    // Dibujar etapas
    Object.keys(stageCoordinates).forEach(stage => {
        const coords = stageCoordinates[stage];
        ctx.fillStyle = coords.color + '80'; // Más opaco para mejor visibilidad
        ctx.strokeStyle = coords.color;
        ctx.lineWidth = 4; // Línea más gruesa
        ctx.fillRect(coords.x, coords.y, coords.width, coords.height);
        ctx.strokeRect(coords.x, coords.y, coords.width, coords.height);
        
        // Texto de la etapa con fondo blanco para mejor legibilidad
        ctx.fillStyle = 'white';
        ctx.fillRect(coords.x + coords.width/2 - 60, coords.y + coords.height/2 - 15, 120, 30);
        ctx.fillStyle = coords.color;
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(stage.replace('_', ' '), coords.x + coords.width/2, coords.y + coords.height/2 + 5);
    });
    
    // Dibujar espacios verdes
    greenAreas.forEach(area => {
        ctx.fillStyle = '#00FF0080'; // Verde brillante más opaco
        ctx.strokeStyle = '#00FF00';
        ctx.lineWidth = 3; // Línea más gruesa
        ctx.fillRect(area.x, area.y, area.width, area.height);
        ctx.strokeRect(area.x, area.y, area.width, area.height);
        
        // Texto del área verde
        ctx.fillStyle = 'white';
        ctx.fillRect(area.x + area.width/2 - 40, area.y + area.height/2 - 10, 80, 20);
        ctx.fillStyle = '#00FF00';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(area.name, area.x + area.width/2, area.y + area.height/2 + 3);
    });
}

function drawTooltip(ctx, lot) {
    const tooltipX = lot.x + lot.width/2;
    const tooltipY = lot.y - 10;
    
    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.fillRect(tooltipX - 50, tooltipY - 30, 100, 25);
    
    ctx.fillStyle = 'white';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(lot.name, tooltipX, tooltipY - 15);
}

function handleClick(event) {
    const rect = event.target.getBoundingClientRect();
    const x = (event.clientX - rect.left) / currentZoom;
    const y = (event.clientY - rect.top) / currentZoom;
    
    // Verificar clic en etapas
    Object.keys(stageCoordinates).forEach(stage => {
        const coords = stageCoordinates[stage];
        if (x >= coords.x && x <= coords.x + coords.width &&
            y >= coords.y && y <= coords.y + coords.height) {
            showStageInfo(stage);
            return;
        }
    });
    
    // Verificar clic en espacios verdes
    greenAreas.forEach(area => {
        if (x >= area.x && x <= area.x + area.width &&
            y >= area.y && y <= area.y + area.height) {
            showGreenAreaInfo(area);
            return;
        }
    });
}

function showStageInfo(stage) {
    const stageInfo = {
        'ETAPA_1': { name: 'Etapa 1', status: 'Vendida', lots: 45, description: 'Primera etapa del desarrollo, completamente vendida' },
        'ETAPA_2A': { name: 'Etapa 2A', status: 'En Venta', lots: 38, description: 'Segunda etapa, lotes disponibles para compra' },
        'ETAPA_2B': { name: 'Etapa 2B', status: 'Desarrollo', lots: 42, description: 'En desarrollo, próximamente disponible' },
        'ETAPA_3': { name: 'Etapa 3', status: 'Futuro', lots: 35, description: 'Planificada para futuras expansiones' }
    };
    
    const info = stageInfo[stage];
    document.getElementById('lotTitle').textContent = info.name;
    document.getElementById('lotStage').textContent = info.name;
    document.getElementById('lotArea').textContent = `${info.lots} lotes`;
    document.getElementById('lotStatus').textContent = info.status;
    document.getElementById('lotDescription').textContent = info.description;
    document.getElementById('lotInfoCard').style.display = 'block';
}

function showGreenAreaInfo(area) {
    document.getElementById('lotTitle').textContent = area.name;
    document.getElementById('lotStage').textContent = 'Espacio Verde';
    document.getElementById('lotArea').textContent = area.area;
    document.getElementById('lotStatus').textContent = 'Público';
    document.getElementById('lotDescription').textContent = 'Área verde común para recreación y esparcimiento';
    document.getElementById('lotInfoCard').style.display = 'block';
}

function updateStatistics() {
    document.getElementById('totalLots').textContent = '160';
    document.getElementById('soldLots').textContent = '45';
    document.getElementById('availableLots').textContent = '115';
    document.getElementById('greenAreas').textContent = '7';
}

// Funciones de zoom y navegación
function zoomIn() {
    if (currentZoom < mapConfig.zoomLevels.max) {
        currentZoom += mapConfig.zoomLevels.step;
        drawMap();
    }
}

function zoomOut() {
    if (currentZoom > mapConfig.zoomLevels.min) {
        currentZoom -= mapConfig.zoomLevels.step;
        drawMap();
    }
}

function resetZoom() {
    currentZoom = 1;
    drawMap();
}

function handleZoom(event) {
    event.preventDefault();
    if (event.deltaY < 0) {
        zoomIn();
    } else {
        zoomOut();
    }
}

function startDrag(event) {
    isDragging = true;
    lastMousePos = { x: event.clientX, y: event.clientY };
}

function onMouseMove(event) {
    if (isDragging) {
        const deltaX = event.clientX - lastMousePos.x;
        const deltaY = event.clientY - lastMousePos.y;
        
        // Implementar pan del mapa aquí
        lastMousePos = { x: event.clientX, y: event.clientY };
        drawMap();
    }
}

function stopDrag() {
    isDragging = false;
}

function toggleLegend() {
    const legend = document.querySelector('.card-body');
    legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
}

function showLotDetails() {
    const modal = new bootstrap.Modal(document.getElementById('lotDetailsModal'));
    document.getElementById('lotModalTitle').textContent = document.getElementById('lotTitle').textContent;
    document.getElementById('lotModalBody').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Información General</h6>
                <p><strong>Etapa:</strong> ${document.getElementById('lotStage').textContent}</p>
                <p><strong>Área:</strong> ${document.getElementById('lotArea').textContent}</p>
                <p><strong>Estado:</strong> ${document.getElementById('lotStatus').textContent}</p>
            </div>
            <div class="col-md-6">
                <h6>Descripción</h6>
                <p>${document.getElementById('lotDescription').textContent}</p>
            </div>
        </div>
    `;
    modal.show();
}

function contactAboutLot() {
    // Implementar formulario de contacto
    alert('Función de contacto en desarrollo');
}
</script>
{% endblock %}
