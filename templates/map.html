{% extends "base.html" %}

{% block title %}Mapa del Barrio - Tejas Cuatro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-map me-2"></i>Mapa Interactivo - Tejas Cuatro
            </h2>
            <p class="text-muted mb-0">Explora las diferentes etapas y lotes del barrio</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="resetZoom()">
                <i class="bi bi-arrows-fullscreen me-2"></i>Vista Completa
            </button>
            <button class="btn btn-outline-info" onclick="toggleLegend()">
                <i class="bi bi-info-circle me-2"></i>Leyenda
            </button>
        </div>
    </div>

    <!-- Controles del Mapa -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-geo-alt me-2"></i>Mapa del Barrio
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomIn()">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomOut()">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Mensaje informativo -->
                    <div class="alert alert-info m-3 mb-0" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>¬°Plano Interactivo de Tejas Cuatro!</strong> Haz clic en las √°reas punteadas para ver informaci√≥n detallada de etapas y espacios verdes. 
                        Usa los controles de zoom para explorar el desarrollo.
                    </div>
                    
                    <div id="mapContainer" class="position-relative" style="height: 600px; overflow: hidden;">
                        <canvas id="mapCanvas" width="1200" height="800" style="cursor: crosshair;"></canvas>
                        
                        <!-- Overlay para informaci√≥n -->
                        <div id="mapInfo" class="position-absolute top-0 start-0 p-3" style="display: none;">
                            <div class="card bg-white shadow-sm">
                                <div class="card-body p-3">
                                    <h6 id="infoTitle" class="mb-2"></h6>
                                    <p id="infoDescription" class="mb-2 small"></p>
                                    <div id="infoDetails" class="small text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Informaci√≥n -->
        <div class="col-md-4">
            <!-- Leyenda -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-legend me-2"></i>Leyenda
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #FF6B6B; border: 2px dashed #FF6B6B;"></div>
                        <small>Etapa 1 - Manzanas 40-57 (Vendida)</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #4ECDC4; border: 2px dashed #4ECDC4;"></div>
                        <small>Etapa 2A - Manzanas 20-39 (En Venta)</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #45B7D1; border: 2px dashed #45B7D1;"></div>
                        <small>Etapa 2B - Manzanas 1-19 (Desarrollo)</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #96CEB4; border: 2px dashed #96CEB4;"></div>
                        <small>Etapa 3 - Manzanas 58-70 (Futuro)</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #2ECC71; border: 2px dashed #2ECC71;"></div>
                        <small>Espacios Verdes (E.V.1 a E.V.7)</small>
                    </div>
                    <hr>
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Haz clic en las √°reas punteadas para ver informaci√≥n detallada
                    </small>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>Estad√≠sticas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <div class="h5 text-primary mb-0" id="totalLots">0</div>
                            <small class="text-muted">Total Lotes</small>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="h5 text-success mb-0" id="soldLots">0</div>
                            <small class="text-muted">Vendidos</small>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="h5 text-warning mb-0" id="availableLots">0</div>
                            <small class="text-muted">Disponibles</small>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="h5 text-info mb-0" id="greenAreas">0</div>
                            <small class="text-muted">Espacios Verdes</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Lote Seleccionado -->
            <div class="card border-0 shadow-sm" id="lotInfoCard" style="display: none;">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-house me-2"></i>Informaci√≥n del Lote
                    </h6>
                </div>
                <div class="card-body">
                    <h6 id="lotTitle" class="mb-2"></h6>
                    <div class="mb-2">
                        <strong>Etapa:</strong> <span id="lotStage"></span>
                    </div>
                    <div class="mb-2">
                        <strong>√Årea:</strong> <span id="lotArea"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Estado:</strong> <span id="lotStatus"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Descripci√≥n:</strong> <span id="lotDescription"></span>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary" onclick="showLotDetails()">
                            <i class="bi bi-info-circle me-1"></i>Ver Detalles
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="contactAboutLot()">
                            <i class="bi bi-envelope me-1"></i>Consultar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles del lote -->
<div class="modal fade" id="lotDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lotModalTitle">Detalles del Lote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="lotModalBody">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="contactAboutLot()">Consultar Disponibilidad</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let mapData = {{ blocks|map('to_dict')|list|tojson }};
let currentZoom = 1;
let isDragging = false;
let lastMousePos = { x: 0, y: 0 };
let selectedLot = null;

// Configuraci√≥n del mapa
const mapConfig = {
    imageSrc: '{{ url_for("static", filename="images/tejas4-map.png") }}',
    width: 1200,
    height: 800,
    zoomLevels: {
        min: 0.5,
        max: 3,
        step: 0.2
    }
};

// Coordenadas de las etapas (basadas en la imagen real de Tejas Cuatro)
const stageCoordinates = {
    'ETAPA_1': { x: 700, y: 500, width: 400, height: 250, color: '#FF6B6B' }, // Rojo suave
    'ETAPA_2A': { x: 300, y: 200, width: 350, height: 200, color: '#4ECDC4' }, // Turquesa
    'ETAPA_2B': { x: 100, y: 400, width: 300, height: 250, color: '#45B7D1' }, // Azul claro
    'ETAPA_3': { x: 500, y: 700, width: 350, height: 200, color: '#96CEB4' }  // Verde suave
};

// Espacios verdes (basados en la imagen real)
const greenAreas = [
    { id: 'EV1', x: 850, y: 50, width: 150, height: 120, area: '8121.0m¬≤', name: 'E.V.1 - Plaza Central' },
    { id: 'EV2', x: 750, y: 350, width: 100, height: 80, area: '2333.7m¬≤', name: 'E.V.2 - Parque Norte' },
    { id: 'EV3', x: 500, y: 100, width: 120, height: 90, area: '2093.91m¬≤', name: 'E.V.3 - Reserva Natural' },
    { id: 'EV4', x: 400, y: 600, width: 60, height: 40, area: '314.16m¬≤', name: 'E.V.4 - Plaza Sur' },
    { id: 'EV5', x: 350, y: 650, width: 50, height: 35, area: '295.73m¬≤', name: 'E.V.5 - Jard√≠n Central' },
    { id: 'EV6', x: 50, y: 700, width: 180, height: 140, area: '5342.93m¬≤', name: 'E.V.6 - Parque Grande' },
    { id: 'EV7', x: 450, y: 750, width: 40, height: 30, area: '350.40m¬≤', name: 'E.V.7 - Jard√≠n Este' }
];

// Inicializar mapa
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    updateStatistics();
});

function initializeMap() {
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    
    // Cargar imagen del mapa
    const mapImage = new Image();
    mapImage.onload = function() {
        drawMap();
    };
    mapImage.src = mapConfig.imageSrc;
    
    // Event listeners
    canvas.addEventListener('mousedown', startDrag);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', stopDrag);
    canvas.addEventListener('wheel', handleZoom);
    canvas.addEventListener('click', handleClick);
}

function drawMap() {
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    
    // Limpiar canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Aplicar transformaciones
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(currentZoom, currentZoom);
    ctx.translate(-canvas.width/2, -canvas.height/2);
    
    // Dibujar imagen base del mapa real
    const mapImage = new Image();
    mapImage.onload = function() {
        // Dibujar la imagen del mapa
        ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
        
        // Dibujar √°reas interactivas sutiles
        drawInteractiveAreas(ctx);
        
        // Dibujar tooltips si hay hover
        if (selectedLot) {
            drawTooltip(ctx, selectedLot);
        }
    };
    mapImage.onerror = function() {
        // Si la imagen no carga, mostrar mensaje informativo
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#6c757d';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Mapa de Tejas Cuatro', canvas.width/2, canvas.height/2 - 50);
        
        ctx.font = '16px Arial';
        ctx.fillText('Plano de Lote Joven - Tejas Cuatro', canvas.width/2, canvas.height/2);
        ctx.fillText('Haz clic en las √°reas punteadas para ver informaci√≥n', canvas.width/2, canvas.height/2 + 30);
        
        // Dibujar √°reas interactivas de prueba
        drawInteractiveAreas(ctx);
        
        // Dibujar tooltips si hay hover
        if (selectedLot) {
            drawTooltip(ctx, selectedLot);
        }
    };
    mapImage.src = mapConfig.imageSrc;
    
    ctx.restore();
}

function drawInteractiveAreas(ctx) {
    // Dibujar etapas con overlay sutil
    Object.keys(stageCoordinates).forEach(stage => {
        const coords = stageCoordinates[stage];
        // Solo dibujar borde sutil, sin relleno para no ocultar la imagen
        ctx.strokeStyle = coords.color;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]); // L√≠nea punteada
        ctx.strokeRect(coords.x, coords.y, coords.width, coords.height);
        ctx.setLineDash([]); // Resetear a l√≠nea s√≥lida
        
        // Indicador de interactividad en la esquina
        ctx.fillStyle = coords.color;
        ctx.fillRect(coords.x + coords.width - 20, coords.y, 20, 20);
        
        // Texto peque√±o en la esquina
        ctx.fillStyle = 'white';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('‚Ñπ', coords.x + coords.width - 10, coords.y + 14);
    });
    
    // Dibujar espacios verdes con overlay sutil
    greenAreas.forEach(area => {
        // Solo dibujar borde sutil
        ctx.strokeStyle = '#2ECC71';
        ctx.lineWidth = 2;
        ctx.setLineDash([3, 3]); // L√≠nea punteada m√°s fina
        ctx.strokeRect(area.x, area.y, area.width, area.height);
        ctx.setLineDash([]); // Resetear a l√≠nea s√≥lida
        
        // Indicador de interactividad
        ctx.fillStyle = '#2ECC71';
        ctx.fillRect(area.x + area.width - 15, area.y, 15, 15);
        
        // Texto peque√±o
        ctx.fillStyle = 'white';
        ctx.font = 'bold 10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('üå≥', area.x + area.width - 7.5, area.y + 11);
    });
}

function drawTooltip(ctx, lot) {
    const tooltipX = lot.x + lot.width/2;
    const tooltipY = lot.y - 10;
    
    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.fillRect(tooltipX - 50, tooltipY - 30, 100, 25);
    
    ctx.fillStyle = 'white';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(lot.name, tooltipX, tooltipY - 15);
}

function handleClick(event) {
    const rect = event.target.getBoundingClientRect();
    const x = (event.clientX - rect.left) / currentZoom;
    const y = (event.clientY - rect.top) / currentZoom;
    
    // Verificar clic en etapas
    Object.keys(stageCoordinates).forEach(stage => {
        const coords = stageCoordinates[stage];
        if (x >= coords.x && x <= coords.x + coords.width &&
            y >= coords.y && y <= coords.y + coords.height) {
            showStageInfo(stage);
            return;
        }
    });
    
    // Verificar clic en espacios verdes
    greenAreas.forEach(area => {
        if (x >= area.x && x <= area.x + area.width &&
            y >= area.y && y <= area.y + area.height) {
            showGreenAreaInfo(area);
            return;
        }
    });
}

function showStageInfo(stage) {
    const stageInfo = {
        'ETAPA_1': { 
            name: 'Etapa 1 - Manzanas 40-57', 
            status: 'Vendida', 
            lots: 18, 
            description: 'Primera etapa del desarrollo Lote Joven - Tejas Cuatro. Completamente vendida con infraestructura completa.' 
        },
        'ETAPA_2A': { 
            name: 'Etapa 2A - Manzanas 20-39', 
            status: 'En Venta', 
            lots: 20, 
            description: 'Segunda etapa con lotes disponibles para compra. Infraestructura completa, seguridad 24hs.' 
        },
        'ETAPA_2B': { 
            name: 'Etapa 2B - Manzanas 1-19', 
            status: 'Desarrollo', 
            lots: 19, 
            description: 'En desarrollo, pr√≥ximamente disponible. Lotes en preparaci√≥n con todos los servicios.' 
        },
        'ETAPA_3': { 
            name: 'Etapa 3 - Manzanas 58-70', 
            status: 'Futuro', 
            lots: 13, 
            description: 'Planificada para futuras expansiones del desarrollo Tejas Cuatro.' 
        }
    };
    
    const info = stageInfo[stage];
    document.getElementById('lotTitle').textContent = info.name;
    document.getElementById('lotStage').textContent = info.name;
    document.getElementById('lotArea').textContent = `${info.lots} manzanas`;
    document.getElementById('lotStatus').textContent = info.status;
    document.getElementById('lotDescription').textContent = info.description;
    document.getElementById('lotInfoCard').style.display = 'block';
}

function showGreenAreaInfo(area) {
    document.getElementById('lotTitle').textContent = area.name;
    document.getElementById('lotStage').textContent = 'Espacio Verde';
    document.getElementById('lotArea').textContent = area.area;
    document.getElementById('lotStatus').textContent = 'P√∫blico';
    document.getElementById('lotDescription').textContent = '√Årea verde com√∫n para recreaci√≥n y esparcimiento';
    document.getElementById('lotInfoCard').style.display = 'block';
}

function updateStatistics() {
    document.getElementById('totalLots').textContent = '70';
    document.getElementById('soldLots').textContent = '18';
    document.getElementById('availableLots').textContent = '52';
    document.getElementById('greenAreas').textContent = '7';
}

// Funciones de zoom y navegaci√≥n
function zoomIn() {
    if (currentZoom < mapConfig.zoomLevels.max) {
        currentZoom += mapConfig.zoomLevels.step;
        drawMap();
    }
}

function zoomOut() {
    if (currentZoom > mapConfig.zoomLevels.min) {
        currentZoom -= mapConfig.zoomLevels.step;
        drawMap();
    }
}

function resetZoom() {
    currentZoom = 1;
    drawMap();
}

function handleZoom(event) {
    event.preventDefault();
    if (event.deltaY < 0) {
        zoomIn();
    } else {
        zoomOut();
    }
}

function startDrag(event) {
    isDragging = true;
    lastMousePos = { x: event.clientX, y: event.clientY };
}

function onMouseMove(event) {
    if (isDragging) {
        const deltaX = event.clientX - lastMousePos.x;
        const deltaY = event.clientY - lastMousePos.y;
        
        // Implementar pan del mapa aqu√≠
        lastMousePos = { x: event.clientX, y: event.clientY };
        drawMap();
    }
}

function stopDrag() {
    isDragging = false;
}

function toggleLegend() {
    const legend = document.querySelector('.card-body');
    legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
}

function showLotDetails() {
    const modal = new bootstrap.Modal(document.getElementById('lotDetailsModal'));
    document.getElementById('lotModalTitle').textContent = document.getElementById('lotTitle').textContent;
    document.getElementById('lotModalBody').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Informaci√≥n General</h6>
                <p><strong>Etapa:</strong> ${document.getElementById('lotStage').textContent}</p>
                <p><strong>√Årea:</strong> ${document.getElementById('lotArea').textContent}</p>
                <p><strong>Estado:</strong> ${document.getElementById('lotStatus').textContent}</p>
            </div>
            <div class="col-md-6">
                <h6>Descripci√≥n</h6>
                <p>${document.getElementById('lotDescription').textContent}</p>
            </div>
        </div>
    `;
    modal.show();
}

function contactAboutLot() {
    // Implementar formulario de contacto
    alert('Funci√≥n de contacto en desarrollo');
}
</script>
{% endblock %}
