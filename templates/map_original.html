{% extends "base.html" %}

{% block title %}Mapa Original - Tejas Cuatro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-map me-2"></i>Plano Original - Tejas Cuatro
            </h2>
            <p class="text-muted mb-0">Plano de Lote Joven - Tejas Cuatro Barrio con Seguridad</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="downloadImage()">
                <i class="bi bi-download me-2"></i>Descargar Imagen
            </button>
            <button class="btn btn-outline-info" onclick="toggleFullscreen()">
                <i class="bi bi-arrows-fullscreen me-2"></i>Pantalla Completa
            </button>
            <button class="btn btn-outline-secondary" onclick="resetView()">
                <i class="bi bi-arrows-fullscreen me-2"></i>Vista Completa
            </button>
            <button class="btn btn-outline-warning" onclick="toggleOverlays()">
                <i class="bi bi-eye me-2"></i>Mostrar/Ocultar Overlays
            </button>
        </div>
    </div>

    <!-- Mapa con Imagen Original -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-geo-alt me-2"></i>Plano Original de Tejas Cuatro
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomIn()">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="zoomOut()">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetZoom()">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="text-center p-3 bg-light">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Haz clic en las áreas del mapa para ver información detallada. Usa el botón "Mostrar/Ocultar Overlays" para ver el plano original.
                        </small>
                    </div>
                    
                    <div id="mapContainer" class="position-relative" style="height: 700px; overflow: auto; background: #f8f9fa;">
                        <!-- Imagen original del plano -->
                        <img id="originalMap" 
                             src="{{ url_for('static', filename='images/tejas4-map.png') }}" 
                             alt="Plano Original de Tejas Cuatro"
                             style="width: 100%; height: auto; max-width: none; cursor: grab;"
                             onerror="showMapError()">
                        
                        <!-- Canvas para overlays interactivos -->
                        <canvas id="overlayCanvas" 
                                style="position: absolute; top: 0; left: 0; pointer-events: none; z-index: 10;"
                                onerror="showMapError()">
                        </canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Información del Desarrollo -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Información del Desarrollo
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="h5 text-primary mb-0">70</div>
                            <small class="text-muted">Total Manzanas</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h5 text-success mb-0">18</div>
                            <small class="text-muted">Etapa 1 (Vendida)</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h5 text-warning mb-0">20</div>
                            <small class="text-muted">Etapa 2A (En Venta)</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h5 text-info mb-0">7</div>
                            <small class="text-muted">Espacios Verdes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>Etapas del Desarrollo
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>Etapa 1:</strong> Manzanas 40-57 (Vendida)
                    </div>
                    <div class="mb-2">
                        <strong>Etapa 2A:</strong> Manzanas 20-39 (En Venta)
                    </div>
                    <div class="mb-2">
                        <strong>Etapa 2B:</strong> Manzanas 1-19 (Desarrollo)
                    </div>
                    <div class="mb-2">
                        <strong>Etapa 3:</strong> Manzanas 58-70 (Futuro)
                    </div>
                    <hr>
                    <div class="mb-2">
                        <strong>Espacios Verdes:</strong> E.V.1 a E.V.7
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Detalles del Área</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="contactAboutArea()">Consultar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentZoom = 1;
let isDragging = false;
let startX, startY, translateX = 0, translateY = 0;
let overlaysVisible = true;

// Coordenadas de las áreas interactivas (ajustar según tu imagen real)
const interactiveAreas = {
    'etapa1': {
        x: 700, y: 500, width: 400, height: 250,
        nombre: 'Etapa 1 - Manzanas 40-57',
        estado: 'Vendida',
        manzanas: 18,
        descripcion: 'Primera etapa del desarrollo Lote Joven - Tejas Cuatro. Completamente vendida con infraestructura completa.',
        servicios: ['Agua', 'Luz', 'Gas', 'Cloacas', 'Seguridad 24hs'],
        color: '#FF6B6B'
    },
    'etapa2a': {
        x: 300, y: 200, width: 350, height: 200,
        nombre: 'Etapa 2A - Manzanas 20-39',
        estado: 'En Venta',
        manzanas: 20,
        descripcion: 'Segunda etapa con lotes disponibles para compra. Infraestructura completa, seguridad 24hs.',
        servicios: ['Agua', 'Luz', 'Gas', 'Cloacas', 'Seguridad 24hs', 'Pavimento'],
        color: '#4ECDC4'
    },
    'etapa2b': {
        x: 100, y: 400, width: 300, height: 250,
        nombre: 'Etapa 2B - Manzanas 1-19',
        estado: 'Desarrollo',
        manzanas: 19,
        descripcion: 'En desarrollo, próximamente disponible. Lotes en preparación con todos los servicios.',
        servicios: ['Agua', 'Luz', 'Gas', 'Cloacas', 'En desarrollo'],
        color: '#45B7D1'
    },
    'etapa3': {
        x: 500, y: 700, width: 350, height: 200,
        nombre: 'Etapa 3 - Manzanas 58-70',
        estado: 'Futuro',
        manzanas: 13,
        descripcion: 'Planificada para futuras expansiones del desarrollo Tejas Cuatro.',
        servicios: ['Planificación en curso'],
        color: '#96CEB4'
    },
    'ev1': {
        x: 850, y: 50, width: 150, height: 120,
        nombre: 'E.V.1 - Plaza Central',
        tipo: 'Espacio Verde',
        area: '8121.0m²',
        descripcion: 'Plaza central del desarrollo con áreas de recreación y esparcimiento.',
        servicios: ['Áreas verdes', 'Juegos infantiles', 'Paseos'],
        color: '#2ECC71'
    },
    'ev2': {
        x: 750, y: 350, width: 100, height: 80,
        nombre: 'E.V.2 - Parque Norte',
        tipo: 'Espacio Verde',
        area: '2333.7m²',
        descripcion: 'Parque norte con vegetación nativa y senderos.',
        servicios: ['Senderos', 'Áreas de descanso', 'Vegetación nativa'],
        color: '#2ECC71'
    },
    'ev3': {
        x: 500, y: 100, width: 120, height: 90,
        nombre: 'E.V.3 - Reserva Natural',
        tipo: 'Espacio Verde',
        area: '2093.91m²',
        descripcion: 'Reserva natural preservada para la biodiversidad local.',
        servicios: ['Reserva natural', 'Biodiversidad', 'Senderos ecológicos'],
        color: '#2ECC71'
    },
    'ev4': {
        x: 400, y: 600, width: 60, height: 40,
        nombre: 'E.V.4 - Plaza Sur',
        tipo: 'Espacio Verde',
        area: '314.16m²',
        descripcion: 'Plaza sur con áreas de encuentro comunitario.',
        servicios: ['Área de encuentro', 'Mobiliario urbano'],
        color: '#2ECC71'
    },
    'ev5': {
        x: 350, y: 650, width: 50, height: 35,
        nombre: 'E.V.5 - Jardín Central',
        tipo: 'Espacio Verde',
        area: '295.73m²',
        descripcion: 'Jardín central con especies ornamentales.',
        servicios: ['Jardín ornamental', 'Especies nativas'],
        color: '#2ECC71'
    },
    'ev6': {
        x: 50, y: 700, width: 180, height: 140,
        nombre: 'E.V.6 - Parque Grande',
        tipo: 'Espacio Verde',
        area: '5342.93m²',
        descripcion: 'El parque más grande del desarrollo con múltiples actividades.',
        servicios: ['Deportes', 'Recreación', 'Áreas de picnic', 'Estacionamiento'],
        color: '#2ECC71'
    },
    'ev7': {
        x: 450, y: 750, width: 40, height: 30,
        nombre: 'E.V.7 - Jardín Este',
        tipo: 'Espacio Verde',
        area: '350.40m²',
        descripcion: 'Jardín este con diseño paisajístico.',
        servicios: ['Diseño paisajístico', 'Áreas de descanso'],
        color: '#2ECC71'
    }
};

// Inicializar mapa
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    addEventListeners();
    drawOverlays();
});

function initializeMap() {
    const mapImage = document.getElementById('originalMap');
    const canvas = document.getElementById('overlayCanvas');
    
    // Configurar canvas cuando la imagen cargue
    mapImage.onload = function() {
        canvas.width = mapImage.offsetWidth;
        canvas.height = mapImage.offsetHeight;
        drawOverlays();
    };
    
    // Manejar errores de imagen
    mapImage.onerror = function() {
        showMapError();
    };
}

function addEventListeners() {
    const container = document.getElementById('mapContainer');
    const mapImage = document.getElementById('originalMap');
    const canvas = document.getElementById('overlayCanvas');
    
    // Zoom con rueda del mouse
    container.addEventListener('wheel', function(e) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        const newZoom = Math.max(0.5, Math.min(3, currentZoom + delta));
        setZoom(newZoom);
    });
    
    // Clic en áreas interactivas
    canvas.addEventListener('click', handleCanvasClick);
    canvas.addEventListener('mousemove', handleCanvasHover);
    
    // Arrastrar
    mapImage.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', stopDrag);
}

function drawOverlays() {
    if (!overlaysVisible) return;
    
    const canvas = document.getElementById('overlayCanvas');
    const ctx = canvas.getContext('2d');
    
    // Limpiar canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Aplicar transformaciones
    ctx.save();
    ctx.translate(translateX, translateY);
    ctx.scale(currentZoom, currentZoom);
    
    // Dibujar áreas interactivas
    Object.keys(interactiveAreas).forEach(areaId => {
        const area = interactiveAreas[areaId];
        
        // Área principal
        ctx.strokeStyle = area.color;
        ctx.lineWidth = 3;
        ctx.setLineDash([10, 5]);
        ctx.strokeRect(area.x, area.y, area.width, area.height);
        ctx.setLineDash([]);
        
        // Indicador de información
        ctx.fillStyle = area.color;
        ctx.fillRect(area.x + area.width - 20, area.y, 20, 20);
        
        // Icono de información
        ctx.fillStyle = 'white';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ℹ', area.x + area.width - 10, area.y + 14);
        
        // Texto del área
        ctx.fillStyle = area.color;
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(area.nombre.split(' - ')[0], area.x + area.width/2, area.y + area.height/2);
    });
    
    ctx.restore();
}

function handleCanvasClick(event) {
    const rect = event.target.getBoundingClientRect();
    const x = (event.clientX - rect.left - translateX) / currentZoom;
    const y = (event.clientY - rect.top - translateY) / currentZoom;
    
    // Verificar clic en áreas
    Object.keys(interactiveAreas).forEach(areaId => {
        const area = interactiveAreas[areaId];
        if (x >= area.x && x <= area.x + area.width &&
            y >= area.y && y <= area.y + area.height) {
            showAreaDetails(area);
            return;
        }
    });
}

function handleCanvasHover(event) {
    const rect = event.target.getBoundingClientRect();
    const x = (event.clientX - rect.left - translateX) / currentZoom;
    const y = (event.clientY - rect.top - translateY) / currentZoom;
    
    let hovered = false;
    Object.keys(interactiveAreas).forEach(areaId => {
        const area = interactiveAreas[areaId];
        if (x >= area.x && x <= area.x + area.width &&
            y >= area.y && y <= area.y + area.height) {
            event.target.style.cursor = 'pointer';
            hovered = true;
            return;
        }
    });
    
    if (!hovered) {
        event.target.style.cursor = 'grab';
    }
}

function showAreaDetails(data) {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    
    title.textContent = data.nombre;
    
    let content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Información General</h6>
                <p><strong>Nombre:</strong> ${data.nombre}</p>
                ${data.estado ? `<p><strong>Estado:</strong> <span class="badge bg-success">${data.estado}</span></p>` : ''}
                ${data.tipo ? `<p><strong>Tipo:</strong> ${data.tipo}</p>` : ''}
                ${data.manzanas ? `<p><strong>Manzanas:</strong> ${data.manzanas}</p>` : ''}
                ${data.area ? `<p><strong>Área:</strong> ${data.area}</p>` : ''}
            </div>
            <div class="col-md-6">
                <h6>Descripción</h6>
                <p>${data.descripcion}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Servicios Disponibles</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${data.servicios.map(servicio => `<span class="badge bg-primary">${servicio}</span>`).join('')}
                </div>
            </div>
        </div>
    `;
    
    body.innerHTML = content;
    modal.show();
}

function zoomIn() {
    setZoom(Math.min(3, currentZoom + 0.2));
}

function zoomOut() {
    setZoom(Math.max(0.5, currentZoom - 0.2));
}

function resetZoom() {
    setZoom(1);
}

function setZoom(zoom) {
    currentZoom = zoom;
    const mapImage = document.getElementById('originalMap');
    mapImage.style.transform = `scale(${zoom})`;
    mapImage.style.transformOrigin = 'center center';
    drawOverlays();
}

function resetView() {
    setZoom(1);
    translateX = 0;
    translateY = 0;
    const mapImage = document.getElementById('originalMap');
    mapImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(1)`;
    drawOverlays();
}

function startDrag(event) {
    isDragging = true;
    startX = event.clientX - translateX;
    startY = event.clientY - translateY;
    event.currentTarget.style.cursor = 'grabbing';
}

function onMouseMove(event) {
    if (!isDragging) return;
    
    translateX = event.clientX - startX;
    translateY = event.clientY - startY;
    
    const mapImage = document.getElementById('originalMap');
    mapImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
    drawOverlays();
}

function stopDrag() {
    isDragging = false;
    const mapImage = document.getElementById('originalMap');
    mapImage.style.cursor = 'grab';
}

function toggleFullscreen() {
    const container = document.getElementById('mapContainer');
    if (!document.fullscreenElement) {
        container.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

function toggleOverlays() {
    overlaysVisible = !overlaysVisible;
    const canvas = document.getElementById('overlayCanvas');
    if (overlaysVisible) {
        canvas.style.pointerEvents = 'auto';
        drawOverlays();
    } else {
        canvas.style.pointerEvents = 'none';
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
}

function downloadImage() {
    const link = document.createElement('a');
    link.href = "{{ url_for('static', filename='images/tejas4-map.png') }}";
    link.download = 'plano-tejas-cuatro.png';
    link.click();
}

function showMapError() {
    const container = document.getElementById('mapContainer');
    container.innerHTML = `
        <div class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center">
                <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                <h5 class="mt-3 text-muted">Imagen del Plano no Disponible</h5>
                <p class="text-muted">El archivo del plano no se encuentra en el servidor.</p>
                <small class="text-muted">
                    Por favor, sube la imagen del plano a: <code>static/images/tejas4-map.png</code>
                </small>
            </div>
        </div>
    `;
}

function contactAboutArea() {
    alert('Función de contacto en desarrollo. Próximamente podrás consultar sobre esta área.');
}
</script>

<style>
#originalMap {
    transition: transform 0.3s ease;
}

#overlayCanvas {
    transition: opacity 0.3s ease;
}

#mapContainer {
    scrollbar-width: thin;
    scrollbar-color: #dee2e6 #f8f9fa;
}

#mapContainer::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

#mapContainer::-webkit-scrollbar-track {
    background: #f8f9fa;
}

#mapContainer::-webkit-scrollbar-thumb {
    background: #dee2e6;
    border-radius: 4px;
}

#mapContainer::-webkit-scrollbar-thumb:hover {
    background: #adb5bd;
}
</style>
{% endblock %}
