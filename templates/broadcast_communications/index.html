{% extends "base.html" %}

{% block title %}Comunicados Automáticos{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-megaphone-fill text-primary me-2"></i>
                Sistema de Comunicados Automáticos
            </h1>
            <p class="text-muted">Envío masivo de comunicados por email y WhatsApp con un solo clic</p>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('broadcast_communications.templates') }}" class="btn btn-outline-secondary">
                <i class="bi bi-file-text me-2"></i>Plantillas
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Usuarios
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_users }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Con Email
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.users_with_email }}</div>
                            <div class="text-xs text-muted">{{ "%.1f"|format(stats.email_coverage) }}% cobertura</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-envelope fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Con WhatsApp
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.users_with_phone }}</div>
                            <div class="text-xs text-muted">{{ "%.1f"|format(stats.phone_coverage) }}% cobertura</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-whatsapp fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Cobertura Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "%.0f"|format([stats.email_coverage, stats.phone_coverage]|max) }}%
                            </div>
                            <div class="text-xs text-muted">usuarios alcanzables</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-broadcast fs-2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Broadcast Form -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-send me-2"></i>Nuevo Comunicado
                    </h6>
                </div>
                <div class="card-body">
                    <form id="broadcastForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="broadcastTitle" class="form-label">Título del Comunicado *</label>
                                    <input type="text" class="form-control" id="broadcastTitle" 
                                           placeholder="Ej: Alerta de Seguridad" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="broadcastPriority" class="form-label">Prioridad</label>
                                    <select class="form-select" id="broadcastPriority">
                                        <option value="normal">Normal</option>
                                        <option value="high">Alta</option>
                                        <option value="urgent">Urgente</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="broadcastMessage" class="form-label">Mensaje *</label>
                            <textarea class="form-control" id="broadcastMessage" rows="6" 
                                      placeholder="Escriba aquí el contenido del comunicado..." required></textarea>
                            <div class="form-text">
                                <span id="charCount">0</span> caracteres (máximo 1000)
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Métodos de Envío</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sendEmail" checked>
                                        <label class="form-check-label" for="sendEmail">
                                            <i class="bi bi-envelope me-2"></i>Email
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sendWhatsApp" checked>
                                        <label class="form-check-label" for="sendWhatsApp">
                                            <i class="bi bi-whatsapp me-2"></i>WhatsApp
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="targetUsers" class="form-label">Usuarios Destino</label>
                                    <select class="form-select" id="targetUsers">
                                        <option value="all">Todos los usuarios activos</option>
                                        <option value="admins">Solo administradores</option>
                                        <option value="verified">Usuarios con email verificado</option>
                                        <option value="with_email">Usuarios con email</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning" id="previewAlert" style="display: none;">
                            <h6><i class="bi bi-eye me-2"></i>Vista Previa</h6>
                            <div id="previewContent"></div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="showPreview()">
                                <i class="bi bi-eye me-2"></i>Vista Previa
                            </button>
                            <button type="submit" class="btn btn-primary" id="sendButton">
                                <i class="bi bi-send me-2"></i>Enviar Comunicado
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Quick Templates -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-lightning me-2"></i>Plantillas Rápidas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-danger" onclick="loadTemplate('emergency')">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Emergencia
                        </button>
                        <button class="btn btn-outline-warning" onclick="loadTemplate('maintenance')">
                            <i class="bi bi-tools me-2"></i>Mantenimiento
                        </button>
                        <button class="btn btn-outline-success" onclick="loadTemplate('event')">
                            <i class="bi bi-calendar-event me-2"></i>Evento
                        </button>
                        <button class="btn btn-outline-info" onclick="loadTemplate('security')">
                            <i class="bi bi-shield-check me-2"></i>Seguridad
                        </button>
                        <button class="btn btn-outline-primary" onclick="loadTemplate('expenses')">
                            <i class="bi bi-cash-coin me-2"></i>Expensas
                        </button>
                        <button class="btn btn-outline-secondary" onclick="loadTemplate('weather')">
                            <i class="bi bi-cloud-rain me-2"></i>Clima
                        </button>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <a href="{{ url_for('broadcast_communications.templates') }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-file-text me-2"></i>Ver Todas las Plantillas
                        </a>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-info-circle me-2"></i>Instrucciones
                    </h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <h6>Cómo usar el sistema:</h6>
                        <ol>
                            <li>Escriba el título y mensaje</li>
                            <li>Seleccione la prioridad</li>
                            <li>Elija métodos de envío</li>
                            <li>Defina usuarios destino</li>
                            <li>Use vista previa si desea</li>
                            <li>Haga clic en "Enviar Comunicado"</li>
                        </ol>
                        
                        <h6 class="mt-3">Tipos de Prioridad:</h6>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-primary">Normal</span> - Comunicados rutinarios</li>
                            <li><span class="badge bg-warning">Alta</span> - Asuntos importantes</li>
                            <li><span class="badge bg-danger">Urgente</span> - Emergencias</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Send Confirmation Modal -->
<div class="modal fade" id="sendConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirmar Envío
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <h6>⚠️ ATENCIÓN: Estás a punto de enviar un comunicado masivo</h6>
                    <p class="mb-0">Este mensaje será enviado a <strong id="targetCount">0</strong> usuarios.</p>
                </div>
                
                <div class="mb-3">
                    <h6>Resumen del Comunicado:</h6>
                    <div class="border rounded p-3 bg-light">
                        <strong id="confirmTitle"></strong>
                        <p class="mb-0 mt-2" id="confirmMessage"></p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Métodos de Envío:</h6>
                        <ul id="confirmMethods"></ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Prioridad:</h6>
                        <span id="confirmPriority" class="badge"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmSend()">
                    <i class="bi bi-send me-2"></i>Confirmar Envío
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Character counter
document.getElementById('broadcastMessage').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('charCount').textContent = count;
    
    if (count > 1000) {
        this.value = this.value.substring(0, 1000);
        document.getElementById('charCount').textContent = '1000';
    }
});

// Load template
function loadTemplate(templateId) {
    const templates = {
        'emergency': {
            title: '🚨 ALERTA DE EMERGENCIA',
            message: 'Se ha detectado una situación de emergencia en el barrio. Por favor, manténganse atentos a las instrucciones de seguridad.',
            priority: 'urgent'
        },
        'maintenance': {
            title: '🔧 AVISO DE MANTENIMIENTO',
            message: 'Se realizarán trabajos de mantenimiento programado. Puede haber interrupciones temporales en algunos servicios.',
            priority: 'normal'
        },
        'event': {
            title: '🎉 EVENTO ESPECIAL',
            message: 'Los invitamos a participar en el próximo evento comunitario. ¡Esperamos contar con su presencia!',
            priority: 'normal'
        },
        'security': {
            title: '🛡️ AVISO DE SEGURIDAD',
            message: 'Recordatorio importante sobre las medidas de seguridad del barrio. Mantengamos todos los protocolos vigentes.',
            priority: 'high'
        },
        'expenses': {
            title: '💰 AVISO DE EXPENSAS',
            message: 'Recordatorio: Las expensas del mes vencen próximamente. Por favor, mantengan sus pagos al día.',
            priority: 'normal'
        },
        'weather': {
            title: '🌦️ ALERTA METEOROLÓGICA',
            message: 'Se pronostica mal tiempo para las próximas horas. Tomen las precauciones necesarias.',
            priority: 'high'
        }
    };
    
    const template = templates[templateId];
    if (template) {
        document.getElementById('broadcastTitle').value = template.title;
        document.getElementById('broadcastMessage').value = template.message;
        document.getElementById('broadcastPriority').value = template.priority;
        
        // Update character count
        document.getElementById('charCount').textContent = template.message.length;
    }
}

// Show preview
function showPreview() {
    const title = document.getElementById('broadcastTitle').value;
    const message = document.getElementById('broadcastMessage').value;
    
    if (!title || !message) {
        alert('Complete el título y mensaje para ver la vista previa');
        return;
    }
    
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <strong>${title}</strong>
        <p class="mb-0 mt-2">${message}</p>
    `;
    
    document.getElementById('previewAlert').style.display = 'block';
}

// Handle form submission
document.getElementById('broadcastForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const title = document.getElementById('broadcastTitle').value;
    const message = document.getElementById('broadcastMessage').value;
    const priority = document.getElementById('broadcastPriority').value;
    const targetUsers = document.getElementById('targetUsers').value;
    
    const methods = [];
    if (document.getElementById('sendEmail').checked) methods.push('email');
    if (document.getElementById('sendWhatsApp').checked) methods.push('whatsapp');
    
    if (!methods.length) {
        alert('Seleccione al menos un método de envío');
        return;
    }
    
    // Show confirmation modal
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmPriority').textContent = priority.toUpperCase();
    document.getElementById('confirmPriority').className = `badge bg-${priority === 'urgent' ? 'danger' : priority === 'high' ? 'warning' : 'primary'}`;
    
    const methodsList = document.getElementById('confirmMethods');
    methodsList.innerHTML = '';
    methods.forEach(method => {
        const li = document.createElement('li');
        li.innerHTML = `<i class="bi bi-${method === 'email' ? 'envelope' : 'whatsapp'} me-2"></i>${method.toUpperCase()}`;
        methodsList.appendChild(li);
    });
    
    // Estimate target count
    const targetCount = {{ stats.total_users }};
    document.getElementById('targetCount').textContent = targetCount;
    
    const modal = new bootstrap.Modal(document.getElementById('sendConfirmModal'));
    modal.show();
});

// Confirm and send
async function confirmSend() {
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Enviando...';
    
    const data = {
        title: document.getElementById('broadcastTitle').value,
        message: document.getElementById('broadcastMessage').value,
        priority: document.getElementById('broadcastPriority').value,
        target_users: document.getElementById('targetUsers').value,
        methods: []
    };
    
    if (document.getElementById('sendEmail').checked) data.methods.push('email');
    if (document.getElementById('sendWhatsApp').checked) data.methods.push('whatsapp');
    
    try {
        const response = await fetch('/admin/broadcast/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`✅ ${result.message}\n\n📊 Estadísticas:\n- Total usuarios: ${result.stats.total_users}\n- Email enviados: ${result.stats.email_sent}\n- WhatsApp enviados: ${result.stats.whatsapp_sent}\n- Fallidos: ${result.stats.failed}`);
            
            // Reset form
            document.getElementById('broadcastForm').reset();
            document.getElementById('charCount').textContent = '0';
            document.getElementById('previewAlert').style.display = 'none';
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('sendConfirmModal')).hide();
        } else {
            alert('❌ Error: ' + result.error);
        }
    } catch (error) {
        alert('Error de conexión: ' + error.message);
    } finally {
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="bi bi-send me-2"></i>Enviar Comunicado';
    }
}
</script>
{% endblock %}
